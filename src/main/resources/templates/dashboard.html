<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Dashboard - CPH Petal Studio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h1>Welcome to Your Dashboard</h1>
  <p>Hello, <span th:text="${username}"></span>!</p>
  <div id="userSubscriptions"></div>
  <div id="bouquetList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
  }

  axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

  // Fetch user subscriptions
  axios.get('/api/subscriptions/user')
          .then(function (response) {
            const subscriptions = response.data;
            const subscriptionList = document.getElementById('userSubscriptions');
            subscriptionList.innerHTML = '<h3>Your Subscriptions</h3>';
            subscriptions.forEach(sub => {
              subscriptionList.innerHTML += `<p>${sub.bouquet.name} - ${sub.frequency}</p>`;
            });
          })
          .catch(function (error) {
            console.error('Error fetching subscriptions:', error);
          });

  // Fetch bouquets
  axios.get('/api/bouquets')
          .then(function (response) {
            const bouquets = response.data;
            const bouquetList = document.getElementById('bouquetList');
            bouquetList.innerHTML = '<h3>Available Bouquets</h3>';
            bouquets.forEach(bouquet => {
              bouquetList.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${bouquet.name}</h5>
                                <p class="card-text">${bouquet.description}</p>
                                <p class="card-text">Price: $${bouquet.price}</p>
                                <button class="btn btn-primary" onclick="subscribeToBouquet(${bouquet.id})">Subscribe</button>
                            </div>
                        </div>
                    `;
            });
          })
          .catch(function (error) {
            console.error('Error fetching bouquets:', error);
          });

  function subscribeToBouquet(bouquetId) {
    const subscription = {
      bouquet: { id: bouquetId },
      startDate: new Date().toISOString().split('T')[0],
      endDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
      frequency: 'MONTHLY'
    };

    axios.post('/api/subscriptions', subscription)
            .then(function (response) {
              alert('Subscription created successfully!');
              location.reload();
            })
            .catch(function (error) {
              console.error('Error creating subscription:', error);
              alert('Failed to create subscription. Please try again.');
            });
  }
</script>
</body>
</html>